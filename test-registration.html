<!DOCTYPE html>
<html>
<head>
    <title>Registration Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #1e40af; }
        h2 { color: #059669; margin-top: 0; }
        button {
            background: #1e40af;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #1e3a8a; }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        pre {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid #1e40af;
        }
        .success { color: #059669; font-weight: bold; }
        .error { color: #dc2626; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        label {
            font-weight: 600;
            color: #334155;
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>üß™ Registration & Authentication Test</h1>

    <div class="test-card">
        <h2>Test 1: Register New User</h2>
        <p>Test the registration endpoint with proper error handling</p>
        
        <label>First Name:</label>
        <input type="text" id="firstName" value="Test" />
        
        <label>Last Name:</label>
        <input type="text" id="lastName" value="User" />
        
        <label>Email:</label>
        <input type="email" id="email" value="testuser@example.com" />
        
        <label>Password:</label>
        <input type="password" id="password" value="TestPass123!" />
        
        <button onclick="testRegistration()">üöÄ Test Registration</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
        
        <pre id="registerResult">Results will appear here...</pre>
    </div>

    <div class="test-card">
        <h2>Test 2: Login</h2>
        <p>Test login with the registered user</p>
        
        <button onclick="testLogin()">üîê Test Login</button>
        
        <pre id="loginResult">Results will appear here...</pre>
    </div>

    <div class="test-card">
        <h2>Test 3: Send OTP</h2>
        <p>Test sending OTP for email verification</p>
        
        <button onclick="testSendOTP()">üìß Send OTP</button>
        
        <pre id="otpResult">Results will appear here...</pre>
    </div>

    <div class="test-card">
        <h2>Test 4: Verify OTP</h2>
        <p>Enter the OTP from your email or backend console</p>
        
        <label>OTP Code:</label>
        <input type="text" id="otpCode" placeholder="Enter 6-digit code" maxlength="6" />
        
        <button onclick="testVerifyOTP()">‚úÖ Verify OTP</button>
        
        <pre id="verifyResult">Results will appear here...</pre>
    </div>

    <script>
        const API_BASE = 'http://10.123.22.21:8081';
        let authToken = null;
        let userEmail = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const className = type;
            
            element.innerHTML += `<span class="${className}">[${timestamp}] ${icon} ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearResults() {
            document.getElementById('registerResult').innerHTML = 'Results will appear here...\n';
            document.getElementById('loginResult').innerHTML = 'Results will appear here...\n';
            document.getElementById('otpResult').innerHTML = 'Results will appear here...\n';
            document.getElementById('verifyResult').innerHTML = 'Results will appear here...\n';
        }

        async function testRegistration() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            userEmail = email;
            
            const resultId = 'registerResult';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'Starting registration test...');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        emailAddress: email,
                        password,
                        agreeToTerms: true,
                        agreeToPrivacyPolicy: true
                    })
                });

                log(resultId, `Response status: ${response.status}`);
                log(resultId, `Content-Type: ${response.headers.get('content-type')}`);

                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                    log(resultId, 'Response is JSON');
                } else {
                    result = await response.text();
                    log(resultId, 'Response is plain text');
                }

                log(resultId, `Response: ${JSON.stringify(result, null, 2)}`);

                if (response.ok) {
                    log(resultId, '‚úÖ REGISTRATION SUCCESSFUL!', 'success');
                    log(resultId, 'You can now test login with these credentials', 'success');
                } else {
                    log(resultId, `Registration failed: ${result}`, 'error');
                }
            } catch (error) {
                log(resultId, `Error: ${error.message}`, 'error');
                log(resultId, `Stack: ${error.stack}`, 'error');
            }
        }

        async function testLogin() {
            const email = document.getElementById('email').value || userEmail;
            const password = document.getElementById('password').value;
            
            const resultId = 'loginResult';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'Starting login test...');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });

                log(resultId, `Response status: ${response.status}`);

                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }

                log(resultId, `Response: ${JSON.stringify(result, null, 2)}`);

                if (response.ok && result.token) {
                    authToken = result.token;
                    log(resultId, '‚úÖ LOGIN SUCCESSFUL!', 'success');
                    log(resultId, `Token: ${authToken.substring(0, 20)}...`, 'success');
                    log(resultId, 'Token saved for OTP tests', 'success');
                } else {
                    log(resultId, 'Login failed', 'error');
                }
            } catch (error) {
                log(resultId, `Error: ${error.message}`, 'error');
            }
        }

        async function testSendOTP() {
            const email = document.getElementById('email').value || userEmail;
            
            if (!authToken) {
                alert('Please login first!');
                return;
            }
            
            const resultId = 'otpResult';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'Sending OTP...');
            log(resultId, `Email: ${email}`);
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/email/sendOTP?organizationalEmail=${encodeURIComponent(email)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                log(resultId, `Response status: ${response.status}`);

                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }

                log(resultId, `Response: ${JSON.stringify(result, null, 2)}`);

                if (response.ok) {
                    log(resultId, '‚úÖ OTP SENT!', 'success');
                    log(resultId, 'Check your email or backend console logs', 'warning');
                    log(resultId, 'Enter the OTP in Test 4 below', 'warning');
                } else {
                    log(resultId, 'Failed to send OTP', 'error');
                }
            } catch (error) {
                log(resultId, `Error: ${error.message}`, 'error');
            }
        }

        async function testVerifyOTP() {
            const email = document.getElementById('email').value || userEmail;
            const otp = document.getElementById('otpCode').value;
            
            if (!authToken) {
                alert('Please login first!');
                return;
            }
            
            if (!otp) {
                alert('Please enter OTP code!');
                return;
            }
            
            const resultId = 'verifyResult';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'Verifying OTP...');
            
            try {
                const response = await fetch(
                    `${API_BASE}/api/v1/email/verifyOTP?organizationalEmail=${encodeURIComponent(email)}&otp=${otp}&userRoles=SELLER`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    }
                );

                log(resultId, `Response status: ${response.status}`);

                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }

                log(resultId, `Response: ${JSON.stringify(result, null, 2)}`);

                if (response.ok) {
                    log(resultId, '‚úÖ VERIFICATION SUCCESSFUL!', 'success');
                    log(resultId, 'Your account is now verified as SELLER', 'success');
                    log(resultId, 'You can now use all platform features!', 'success');
                } else {
                    log(resultId, 'Verification failed - check OTP code', 'error');
                }
            } catch (error) {
                log(resultId, `Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
