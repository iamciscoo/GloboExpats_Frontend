# Cart System Analysis

## Components Overview

### 1. **Cart Display Components**

#### Header Cart Button (components/header.tsx)
- **Location**: Lines 151-158, 293-300
- **Component**: `CartSidePanelTrigger`
- **Displays**: Cart icon with item count badge
- **Keyboard Shortcut**: Ctrl/Cmd + K
- **Item Count Source**: `useCart().itemCount`

#### Cart Side Panel (components/cart-sidepanel.tsx)
- **Purpose**: Quick access slide-out cart
- **Features**:
  - Displays cart items with images
  - Remove individual items
  - Clear all cart
  - Checkout button
  - View full cart link
- **Data Source**: `useCart()` hook
- **Shows**: `items`, `itemCount`, `subtotal`, `isEmpty`

#### Cart Page (app/cart/page.tsx)
- **Full cart management interface**
- **Features**:
  - Item selection for checkout
  - Bulk operations
  - Remove items
  - Clear cart
  - Proceed to checkout
- **Data Source**: `useCart()` hook

### 2. **Cart State Management**

#### Cart Provider (providers/cart-provider.tsx)
**Key Flow**:
1. **Initialization** (Line 352-395):
   - On mount, if user is logged in, calls `syncCart()`
   - `syncCart()` fetches cart from backend via `cartService.getCart()`
   - Converts backend data to frontend CartItem format
   - Updates local state and persists to localStorage

2. **Adding Items** (Line 490-599):
   ```typescript
   addItem(item: Omit<CartItem, 'quantity'>)
   ```
   - Checks if user is logged in
   - Validates productId exists
   - Calls `cartService.addToCart(productId, 1)`
   - Fetches updated cart from backend
   - Updates local state with backend response
   - Persists to localStorage
   - Shows success toast

3. **Removing Items** (Line 601-656):
   - Calls `cartService.removeFromCart(cartId)`
   - Updates local state
   - Persists to localStorage

4. **Cart Data Structure**:
   ```typescript
   interface CartItem {
     id: string              // cartId from backend (as string)
     productId?: number      // Product ID for backend operations
     title: string
     price: number
     image: string
     quantity: number
     // ... other fields
   }
   ```

### 3. **Backend Integration**

#### Cart Service (lib/cart-service.ts)
- **addToCart(productId, quantity)**: POST `/api/v1/cart/add`
- **getCart()**: GET `/api/v1/cart/User`
- **updateCartItem(cartId, productId, quantity)**: PUT `/api/v1/cart/item/{cartId}`
- **removeFromCart(cartId)**: DELETE `/api/v1/cart/item/{cartId}`
- **clearCart()**: DELETE `/api/v1/cart/clear`

#### API Client (lib/api.ts)
Lines 1172-1240 define the cart endpoints

### 4. **Product to Cart Flow**

#### Product Actions (components/product-actions.tsx)
Line 52-100: `handleAddToCart()`
1. Validates productId
2. Creates cart item using `productToCartItem()` utility
3. Calls `addToCart(cartItem)`

#### Cart Utils (lib/cart-utils.ts)
**Updated**: Line 16-49: `productToCartItem()`
- Converts product data to CartItem format
- **FIXED**: Now includes `productId` field for backend integration

## Potential Issues & Solutions

### Issue 1: Cart appears empty after adding items
**Root Cause**: Multiple possible causes:
1. Backend API not returning cart data correctly
2. Cart sync not triggered after add
3. productId not being passed correctly
4. Response data structure mismatch

**Debugging Steps**:
1. Check browser console for logs (we added extensive logging)
2. Check Network tab for API calls to `/api/v1/cart/*`
3. Verify backend returns proper response format:
   ```json
   {
     "success": true,
     "data": {
       "items": [...],
       "totalItems": 1,
       "totalPrice": 1000,
       "currency": "TZS"
     }
   }
   ```

### Issue 2: ProductId not being sent to backend
**Status**: ‚úÖ FIXED
- Updated `productToCartItem()` to include productId
- Added validation in cart provider to check productId exists

### Issue 3: Cart not syncing on login
**Current Flow**:
- Cart syncs on component mount if user is logged in
- Should fetch backend cart and update local state

**Verify**:
- Check if `syncCart()` is being called
- Check network tab for GET `/api/v1/cart/User`
- Check console logs for sync messages

## Console Logging Added

The following debug logs were added:

### In Cart Provider (providers/cart-provider.tsx):
```typescript
// When adding item:
console.log('üõí Cart Provider - Adding item:', {...})
console.log('‚úÖ Calling cartService.addToCart with productId:', productId)
console.log('‚úÖ Item added to backend, fetching updated cart...')
console.log('‚úÖ Cart updated successfully:', {...})

// When error occurs:
console.error('‚ùå Error adding to cart:', error)
```

### In Product Actions (components/product-actions.tsx):
```typescript
console.log('üõí Adding to cart - ProductId:', productId, 'Type:', typeof productId)
console.log('üõí Buy Now - ProductId:', productId, 'Type:', typeof productId)
```

## Testing Checklist

### To verify cart integration:

1. **Open Browser DevTools Console**
2. **Add item to cart**:
   - Should see: `üõí Adding to cart - ProductId: X`
   - Should see: `üõí Cart Provider - Adding item`
   - Should see: `‚úÖ Calling cartService.addToCart`
   - Should see: `‚úÖ Item added to backend`
   - Should see: `‚úÖ Cart updated successfully`

3. **Check Network Tab**:
   - POST to `/api/v1/cart/add` with `{productId: X, quantity: 1}`
   - GET to `/api/v1/cart/User`
   - Both should return success responses

4. **Check Cart Display**:
   - Cart icon badge should update (itemCount)
   - Cart sidepanel should show item
   - Cart page should show item

5. **Check LocalStorage**:
   - Key: `expatCartItems`
   - Should contain cart data with timestamp

## Backend Requirements

The backend MUST return proper response format:

### GET /api/v1/cart/User
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "cartId": 123,
        "productId": 456,
        "quantity": 1,
        "productName": "Product Name",
        "price": 1000,
        "currency": "TZS",
        "subtotal": 1000
      }
    ],
    "totalItems": 1,
    "totalPrice": 1000,
    "currency": "TZS"
  }
}
```

### POST /api/v1/cart/add
```json
Request: {"productId": 456, "quantity": 1}

Response: {"success": true, "data": {...}}
```

## Next Steps

1. Test adding items to cart
2. Monitor console logs
3. Check network requests
4. Verify backend responses
5. If cart still empty, check if:
   - User is authenticated
   - Backend API is accessible
   - Response format matches expected structure
