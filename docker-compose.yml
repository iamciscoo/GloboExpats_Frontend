# =============================================================================
# DOCKER COMPOSE - EXPAT MARKETPLACE FRONTEND
# =============================================================================
# Multi-environment Docker Compose configuration
# Supports development, staging, and production deployments
# =============================================================================

version: '3.8'

services:
  # =============================================================================
  # FRONTEND SERVICE
  # =============================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
      args:
        - NODE_ENV=${NODE_ENV:-production}
    image: expat-frontend:${TAG:-latest}
    container_name: ${CONTAINER_NAME:-expat-frontend-container}
    restart: unless-stopped

    # Port mapping
    ports:
      - '${PORT:-3000}:3000'

    # Environment variables
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_TELEMETRY_DISABLED=1
      - BACKEND_URL=${BACKEND_URL:-http://backend:8000}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000/api}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:8000/ws}
      - NEXT_PUBLIC_CDN_URL=${NEXT_PUBLIC_CDN_URL:-}
      - NEXT_PUBLIC_ENVIRONMENT=${NODE_ENV:-production}

    # Health check
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Networks
    networks:
      - expat-network

    # Labels for container management
    labels:
      - 'com.expat.service=frontend'
      - 'com.expat.environment=${NODE_ENV:-production}'
      - 'com.expat.version=${TAG:-latest}'

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  expat-network:
    driver: bridge
    labels:
      - 'com.expat.network=main'

# =============================================================================
# VOLUMES (if needed for persistent data)
# =============================================================================
volumes:
  frontend-cache:
    driver: local
    labels:
      - 'com.expat.volume=frontend-cache'
